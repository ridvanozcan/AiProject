# Historical Buildings Model Recognition

This is a master project for the artificial intelligence.
This project consists of a classifier of a historical buildings model.

## Requirements
- Python3
- numpy
- pytorch
- torchvision
- scikit-learn
- matplotlib
- pillow
- torch (pytorch)
- torchvision

You can install the requirements using:
```
pip3 install -r requirements.txt
```

**Troubleshooting**: if you get some errors about pytorch or torchvision install use `sudo` to install it.

## Usage

First, if you have no resnet152 model trained and you need from scratch to do it you need to:

- download dataset
- preprocess the dataset
- train the model

Afterward you can try a new sample.

### Download dataset

I suggest using istanbul as a dataset, it's free and full of labeled images for historical buildings model recognition instead of detection (most datasets are for this).

So download the dataset, select some models and put the directory model in the dataset folder, any directory in "dataset" will be considered a new class.

If you need more data for your project you can also add the followings dataset:
```
!pip install roboflow

from roboflow import Roboflow
rf = Roboflow(api_key="")
project = rf.workspace("ridvan").project("istanbul")
dataset = project.version(1).download("voc")
```

### Handle CSV training, testing, validation and dataset structure

The dataset structure should be like this:
```
dataset / classes / file.jpg
```

For example, we have 5 classes: **topkapi, ayasofya, kizkulesi, galata and sultanahmet**:
```
dataset_dir / topkapi / file1.jpg
dataset_dir / ayasofya / file2.jpg
dataset_dir / kizkulesi / file3.jpg
dataset_dir / galata / file4.jpg
dataset_dir / sultanahmet / file5.jpg
...
and so on.
```

The **"dataset_dir"** is the **IMAGES_PATH** in config.py.
The python script will save the classes in a  dict() named **num_classes**, like this:
```
num_classes = {
  "topkapi": 1,
  "ayasofya": 2,
  "kizkulesi": 3,
  "galata": 4,
  "sultanahmet": 5
}
```

This conversion happens automatically when you just add a directory inside the IMAGES_PATH, if you add tomorrow a new buildings, like, Yerebatan Sarnıcı, the program will add automatically to the classes, just **pay attention to the order of the classes inside num_classes and the related training, testing and validation CSV files**.

The file **training, testing, and validation (CSV)** should contain only two columns:
**FILE_NAME, NUM_CLASS**

Example of CSV file:
```
file1.jpg, 1
file2.jpg, 1
file1.jpg, 2
file2.jpg, 2
file1.jpg, 3
file2.jpg, 3
```

Anyway, this paragraph is only for your info, the CSV files are automatically generated by the preprocessing phase explained in the following paragraph.


### Preprocess the dataset
You have to generate the CSV files and calculate the mean and standard deviation to apply a normalization, just use the -p parameter to process your dataset so type:

```
$ python3 main.py -p
```

### Train the model

**Short introduction**

Before the training process, modify the `EPOCHS` parameter in `config.py`, usually with 3 classes 30-50 epochs should be enough, but you have to see the `results_graph.png` file (when you finish your training with the default epochs parameter) and check if the blue curve is stable.

After 45-50 epochs (number bottom of the graph), the blue curve is stable and does not have peaks down.
Moreover, the testing curve (the orange one) is pretty "stable", even with some peaks, for the testing is normal that the peaks are frequently.

**Train the model**

To train a new model resnet152 model you can run the main.py with the -t parameter, so type:

```
$ python3 main.py -t
```

The results will be saved in the results/ directory with the F1 score, accuracy, confusion matrix, and the accuracy/loss graph difference between training and testing.

## Try a new sample

Try to predict a new sample you can just type:
```
python3 main.py -i path/file.jpg
```

---

I used this project to predict 5 models:
- İstanbul / Topkapı Sarayı
- İstanbul / Sultanahmet Camii
- İstanbul / Ayasofya Camii
- İstanbul / Kız Kulesi
- İstanbul / Galata Kulesi

I selected all 2000-2023 images from Google Free İmages, so I downloaded the full dataset and choose the 2000-2023 images and put them into one directory per class (so I had 5 directories named "Topkapı", "Sultanahmet", "Ayasofya", "KızKulesi", "Galata" in dataset folder).

## Troubleshooting

### - Size mismatch

Error:
```python
RuntimeError: Error(s) in loading state_dict for ResNet:
size mismatch for fc.weight: copying a param with shape torch.Size([1000, 2048]) from checkpoint, the shape in current model is torch.Size([3, 2048]).
size mismatch for fc.bias: copying a param with shape torch.Size([1000]) from checkpoint, the shape in current model is torch.Size([3]).
```

**Solution**: you probably need to re-train your neural network model because you are using the wrong model for your data and classes, so don't use some **pretrained** model but train a new neural network with your data/classes.

### - CUDA out of memory

Error:
```python
######### ERROR #######
CUDA out of memory. Tried to allocate 20.00 MiB (GPU 0; 1.96 GiB total capacity; 967.98 MiB already allocated; 25.94 MiB free; 48.02 MiB cached)


######### batch #######
[images.png, files_path.png, ....]

Traceback (most recent call last):
  File "main.py", line 227, in <module>
    train_model_iter("resnet152", resnet152_model)
  File "main.py", line 215, in train_model_iter
    model, loss_acc, y_testing, preds = train_model(model_name=model_name, model=model, weight_decay=weight_decay)
  File "main.py", line 124, in train_model
    epoch_loss /= samples
ZeroDivisionError: division by zero
```

**Solution**: you're using CUDA, probably, the memory of your GPU is too low for the batch size that you're giving in input, try to reduce the `BATCH_SIZE` from **config.py** or use your RAM instead of GPU memory if you have more, so put `USE_CUDA=false` in **config.py**.

### - "My model does not recognize exactly the class"
Probably you have to increase the **DATA PER CLASS** in your dataset, a good number of images per class could be 10k (10 000 items), but with only 5 classes you can even use 2k-5k items per class.
Another parameter that affects hugely the training is the **EPOCHS**, try to at least 50 epochs if you are not satisfied with the results.


### - Literature Review
Abebech Jenber Belay, Ayodeji Olalekan Salau,Minale Ashagrie, Melaku Bitew Haile. "Development of a chickpea disease detection and classification model using deep learning", Informatics in Medicine Unlocked, 2022

Alex Krizhevsky, Ilya Sutskever, Geoffrey E. Hinton (2012). ImageNet classification with deep 	convolutional neural networks, 84–90

Brown, B. (2007). Working the problems of tourism. Annals of Tourism Research, 34 (2), 364-383.
Bulent B., Batuhan K., Furkan O., (2020). A Deep learning integrated mobile application for historic landmark recognition: A case study of Istanbul 38-50.

Cheng, Z., Shen, J. (2016). On very large scale test collection for landmark image search benchmarking. 	Signal Processing, 124, 13–26.

Christian S., Wei L.,  Pierre S., Scott R., Dragomir A., Dumitru E., Vincent V., Andrew R., Yangqing J. (2014). Going deeper with convolutions, 1409.4842v1CoreML Framework, (2018). CoreML Framework Overview, https://www.netguru.com/blog/coreml-vs-tensorflow-lite-mobile [Accessed on 19 December 2018].

Deng, J., Berg, A., Satheesh, S., Su, H., Khosla, A., Fei-Fei, 	L. (2012). ImageNet Large Scale Visual Recognition Competition (ILSVRC2012). http://www.imagenet.org/challenges/LSVRC/ 2012/.

Dizaji, Kamran Ghasedi. "Efficient Learning Framework for Training Deep Learning Models with Limited Supervision", University of Pittsburgh, 2021

Fakhri lahmood HAMEED, Omar DAKKAK. “Brain Tumor Detection and Classification Using Convolutional Neural Network (CNN)", 2022 International Congress on Human-Computer Interaction, Optimization and Robotic Applications (HORA), 2022

Hays, J., Efros, A.A. (2008). IM2GPS: Estimating geographic information from a single image. In 26th 	 IEEE Conference on Computer Vision and Pattern 	 Recognition (CVPR).

Huei-Fang Yang, Bo-Yao Lin, Kuang-Yu Chang, Chu-Song Chen. "Joint Estimation of Age and Expression by Combining Scattering and Convolutional Networks", ACM Transactions on Multimedia Computing, Communications, and Applications, 2018 

Jing Zhang, Chao Wang, Xianbo Zhang, Zezhou Li. "Multi-Attention Integrated Convolutional Network for Anomaly Detection of Time Series", 2022 14th International Conference on Computer and Automation Engineering (ICCAE), 2022

Karthik Ananth Mani, Eduard Belausov, Einat Zelinger, Guy Mechrez. “Durable superhydrophobic coating with a self-replacing mechanism of urface roughness based on multiple Pickering emulsion templating", Colloids and Surfaces A: Physicochemical 	and Engineering Aspects, 2022

M. Sarıgül, B.M. Ozyildirim, M. Avci. “Differential convolutional neural network", Neural Networks, 2019

M. Sreeraj, Jestin Joy, Manu Jose, Meenu Varghese, T.J. Rejoice. "Comparative analysis of Machine Learning approaches for early stage Cervical Spondylosis detection", Journal of King Saud University - Computer and Information Sciences, 2020

Myneni Madhu Bala, Haritha Akkineni, Siva Abhishek Sirivella, Siddharth Ambati, Krishna Vamshi Potharaju Venkata Sai. "Implementation of an adaptive E-learning platform with facial emotion recognition”, Microsystem Technologies, 2023

Nawaz, M., Sewissy, A.A., Soliman, T.H.A. (2018).  Multiclass breast cancer classification using deep  learning convolutional neural network. International  Journal of Advanced Computer Science and Applications, 9 (6), 316–332


Olga Russakovsky, Jia Deng, Hao Su, Jonathan Krause et al. "ImageNet Large Scale Visual Recognition Challenge", International Journal of  Computer Vision, 2015

Parkhi, O.M., Vedaldi, A., Zisserman, A. (2015). Deep face recognition. In Proceedings of the British Machine Vision Conference 2015, pp. 41.1–41.12.

Richards, G. (2018). Cultural tourism: A review of recent research and trends. Journal of Hospitality and Tourism  Management, 36, 12–21.

Risa Karakida Kawaguchi, Ziqi Tang, Stephan Fischer, Chandana Rajesh, Rohit Tripathy, Peter K. Koo, Jesse Gillis. "Learning single-cell chromatin accessibility profiles using meta-analytic marker genes", Cold Spring Harbor Laboratory, 2022

Shahab Aslani, Michael Dayan, Vittorio Murino, Diego Sona. "Chapter 13 Deep 2D Encoder- Decoder Convolutional Neural Network for Multiple 	 Sclerosis Lesion Segmentation in Brain MRI", Springer  Nature, 2019

Simonyan, K., Zisserman, A. (2014). Very deep  convolutional networks for large-scale image recognition. arXiv preprint arXiv:1409.1556.

Tao Dai, Jeya Maria Jose, Vishal Patel, Sarah Marie Jordaan. "The Life Cycle Land Use of Natural Gas-Fired Electricity in the US Western Interconnection”, Environmental Science: Advances, 2023

UNESCO, (2006). Cities Named '2010 European Capital of 	                     Culture' include World Heritage sites. https://whc.unesco.org/en/news/248/ [Accessed on 12 	September 2019].

Zhou, B., Lapedriza, A., Khosla, A., Oliva, A., Torralba, A. (2018). Places: A 10 million image database for scene recognition. IEEE Transactions on Pattern Analysis and Machine Intelligence, 40 (6), 1452–1464.

Wasay, Abdul. "Computation-Cautious Machine Learning Systems.", Harvard University, 2021

Weyand, T., Leibe, B. (2015). Visual landmark recognition from Internet photo collections: A largescale evaluation. Computer Vision and Image Understanding, 135, 1–15.

